<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>COC Planner — Schedule</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --gold:     #f5d04c;
      --bg:       #101013;
      --surface:  #19191e;
      --surface2: #23232b;
      --border:   rgba(255,255,255,0.08);
      --text:     #ffffff;
      --text-dim: #9999a8;
      /* Bright, harmonious palette — coral, sky, mint, amber, lavender, teal */
      --b1: #FF6B6B;
      --b2: #45B7D1;
      --b3: #51CF66;
      --b4: #FFD43B;
      --b5: #CC5DE8;
      --b6: #20C997;
    }

    html, body { height:100%; background:var(--bg); font-family:'Lexend',sans-serif; color:var(--text); overflow-x:hidden; }

    /* ── HEADER ── */
    .gantt-header {
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 20px; background:var(--surface);
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:200; gap:12px;
    }
    .gantt-title { font-size:18px; font-weight:800; color:var(--gold); letter-spacing:.5px; white-space:nowrap; }
    .back-btn {
      display:flex; align-items:center; gap:6px;
      background:var(--surface2); border:1px solid var(--border); border-radius:10px;
      padding:8px 14px; color:var(--text-dim); font-family:'Lexend',sans-serif;
      font-size:13px; font-weight:600; cursor:pointer; transition:all .18s; white-space:nowrap;
    }
    .back-btn:hover { color:var(--text); border-color:var(--gold); }
    .refresh-btn {
      display:flex; align-items:center; gap:6px;
      background:var(--gold); border:none; border-radius:10px;
      padding:8px 14px; color:#000; font-family:'Lexend',sans-serif;
      font-size:13px; font-weight:700; cursor:pointer; transition:all .18s; white-space:nowrap;
    }
    .refresh-btn:hover { background:#ffd700; }
    .refresh-btn.loading { opacity:.7; pointer-events:none; }

    /* ── TOGGLES ── */
    .builder-toggles {
      display:flex; gap:8px; padding:10px 20px;
      background:var(--surface); border-bottom:1px solid var(--border);
      overflow-x:auto; position:sticky; top:57px; z-index:190;
      justify-content:center;
    }
    .builder-toggles::-webkit-scrollbar { display:none; }
    .toggle-btn {
      display:flex; align-items:center; gap:7px; padding:7px 14px;
      border-radius:10px; border:1.5px solid var(--border);
      font-family:'Lexend',sans-serif; font-size:12px; font-weight:700;
      cursor:pointer; transition:all .2s; white-space:nowrap;
      background:var(--surface2); color:var(--text-dim); opacity:0.5;
    }
    .toggle-btn.active { opacity:1; color:#fff; }
    .toggle-btn img { width:20px; height:20px; object-fit:contain; border-radius:4px; }
    .toggle-btn[data-b="1"].active { background:rgba(255,107,107,.2); border-color:rgba(255,107,107,.6); color:#FF6B6B; }
    .toggle-btn[data-b="2"].active { background:rgba(69,183,209,.2);  border-color:rgba(69,183,209,.6);  color:#45B7D1; }
    .toggle-btn[data-b="3"].active { background:rgba(81,207,102,.2);  border-color:rgba(81,207,102,.6);  color:#51CF66; }
    .toggle-btn[data-b="4"].active { background:rgba(255,212,59,.2);  border-color:rgba(255,212,59,.6);  color:#FFD43B; }
    .toggle-btn[data-b="5"].active { background:rgba(204,93,232,.2);  border-color:rgba(204,93,232,.6);  color:#CC5DE8; }
    .toggle-btn[data-b="6"].active { background:rgba(32,201,151,.2);  border-color:rgba(32,201,151,.6);  color:#20C997; }

    /* ── ZOOM BAR (desktop only) ── */
    .zoom-bar {
      display:flex; align-items:center; gap:10px; padding:8px 20px;
      background:var(--surface); border-top:1px solid var(--border);
      position:sticky; bottom:0; z-index:190;
    }
    .zoom-label { font-size:11px; font-weight:700; color:var(--text-dim); text-transform:uppercase; letter-spacing:.5px; }
    .zoom-btn {
      width:32px; height:32px; border-radius:8px;
      border:1.5px solid var(--border); background:var(--surface2);
      color:var(--text); font-size:18px; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:all .15s;
    }
    .zoom-btn:hover { border-color:var(--gold); color:var(--gold); }
    .zoom-level { font-size:12px; font-weight:800; color:var(--gold); min-width:40px; text-align:center; }

    /* ── LOADING ── */
    .state-msg {
      display:flex; flex-direction:column; align-items:center;
      justify-content:center; gap:16px; height:300px; color:var(--text-dim); font-size:15px;
    }
    .spinner { width:36px; height:36px; border:3px solid var(--surface2); border-top-color:var(--gold); border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ── DESKTOP GANTT ── */
    .gantt-wrap { overflow-x:auto; overflow-y:visible; }

    /* Bar has overflow:visible so sticky .bar-inner works */
    .gantt-bar {
      position:absolute; border-radius:8px;
      display:flex; align-items:center; padding:0;
      cursor:pointer; overflow:visible;
      transition:filter .15s, box-shadow .15s;
      border:2.5px solid rgba(255,255,255,0.45);
      box-shadow:inset 0 -3px 0 rgba(0,0,0,0.3);
    }
    .gantt-bar:hover { filter:brightness(1.15); box-shadow:0 0 0 2px rgba(255,255,255,0.7), inset 0 -3px 0 rgba(0,0,0,0.3); z-index:5; }

    /* Sticky inner: left is set dynamically = label-col-width, so it hugs that edge */
    .bar-inner {
      display:flex; align-items:center; gap:0;
      overflow:visible; pointer-events:none;
      position:sticky;
    }
    .bar-icon { object-fit:contain; border-radius:5px; flex-shrink:0; background:rgba(0,0,0,.25); padding:3px; }

    .bar-text-col { display:flex; flex-direction:column; gap:1px; overflow:hidden; padding:0 7px; }
    .bar-name     { font-size:11px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,0.8); line-height:1.25; }
    .bar-dur      { font-size:9px;  font-weight:600; color:rgba(255,255,255,0.75); text-shadow:0 1px 2px rgba(0,0,0,0.7); white-space:nowrap; line-height:1.25; }
    .bar-finish-lbl { font-size:8.5px; font-weight:700; color:rgba(255,255,255,0.6); text-shadow:0 1px 2px rgba(0,0,0,0.7); white-space:nowrap; line-height:1.25; }

    .gantt-boost-marker {
      position:absolute; top:2px; width:14px; height:14px; background:#fff;
      border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-size:8px; z-index:3; pointer-events:none; box-shadow:0 1px 4px rgba(0,0,0,.4);
    }
    .bar-active-badge {
      position:absolute; top:-11px; left:6px; background:var(--gold); color:#000;
      font-size:8px; font-weight:800; padding:1px 6px; border-radius:3px; white-space:nowrap; pointer-events:none;
    }

    /* ── TOOLTIP ── */
    .gantt-tooltip {
      position:fixed; background:linear-gradient(135deg,#2a2a2f,#1e1e24);
      border:1.5px solid rgba(245,208,76,.3); border-radius:14px;
      padding:14px 18px; z-index:9999; pointer-events:none;
      max-width:295px; box-shadow:0 12px 40px rgba(0,0,0,.7); display:none;
    }
    .gantt-tooltip.visible { display:block; }
    .tt-name  { font-size:13px; font-weight:800; color:var(--text); margin-bottom:8px; }
    .tt-row   { display:flex; justify-content:space-between; gap:16px; margin-bottom:4px; }
    .tt-label { font-size:10px; color:var(--text-dim); font-weight:700; text-transform:uppercase; letter-spacing:.5px; }
    .tt-value { font-size:11px; color:var(--text); font-weight:600; text-align:right; }
    .tt-boost     { margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-size:11px; color:var(--gold); font-weight:700; }
    .tt-boost-row { font-size:10px; color:#ccc; margin-top:3px; }

    /* ── RESPONSIVE ── */
    @media (max-width:768px) {
      .gantt-wrap { display:none !important; }
      .zoom-bar   { display:none !important; }
      .gantt-mobile { display:block; }
      .gantt-header { padding:12px 14px; }
      .gantt-title  { font-size:15px; }
      .back-btn, .refresh-btn { padding:7px 11px; font-size:12px; }
      .builder-toggles { padding:8px 14px; top:51px; justify-content:flex-start; }
      .toggle-btn { padding:6px 10px; font-size:11px; }
    }
    @media (min-width:769px) { .gantt-mobile { display:none; } }

    /* ── MOBILE GANTT ── */
    .gantt-mobile { padding-bottom:60px; }
    .mobile-columns-wrapper { display:flex; overflow-x:auto; }
    .mobile-columns-wrapper::-webkit-scrollbar { display:none; }

    .mobile-time-axis { flex-shrink:0; width:58px; position:sticky; left:0; background:var(--bg); z-index:10; }
    .mobile-time-header {
      height:84px; border-bottom:1px solid var(--border); border-right:1px solid var(--border);
      display:flex; align-items:flex-end; padding:0 5px 8px;
      font-size:9px; font-weight:700; color:var(--text-dim); text-transform:uppercase;
    }
    .mobile-time-tick {
      border-right:1px solid var(--border); border-bottom:1px solid var(--border);
      display:flex; align-items:flex-start; padding:4px 3px 0;
      font-size:9px; font-weight:700; color:var(--text-dim); white-space:nowrap;
    }
    .mobile-time-tick.today-row { color:var(--gold); border-bottom-color:rgba(245,208,76,.5); }

    /* Columns are 120px — flex so hiding one closes the gap automatically */
    .mobile-builder-col { flex-shrink:0; width:120px; border-right:1px solid var(--border); }
    .mobile-builder-col.hidden-col { display:none; }
    .mobile-col-header {
      height:84px; border-bottom:3px solid;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding:6px 4px;
    }
    .mobile-col-header img { width:32px; height:32px; object-fit:contain; }
    .mobile-col-header span { font-size:11px; font-weight:700; white-space:nowrap; }
    .mobile-col-body { position:relative; }

    /* Mobile bar — overflow:visible so sticky children work */
    .mobile-bar {
      position:absolute; left:4px; right:4px; border-radius:8px;
      border:2px solid rgba(255,255,255,0.3); cursor:pointer; min-height:8px;
      transition:filter .12s;
    }
    .mobile-bar:active { filter:brightness(1.2); }

    /* Sticky label inside bar — sticks relative to page vertical scroll.
       top is set dynamically in JS = header+toggles+col-header height. */
    .mobile-bar-label {
      position:sticky;
      padding:6px 5px 4px;
      display:flex; flex-direction:column; align-items:center; gap:4px;
      pointer-events:none; z-index:3;
    }
    .mobile-bar-icon {
      width:44px; height:44px; object-fit:contain; border-radius:7px;
      background:rgba(0,0,0,.3); padding:3px; flex-shrink:0;
      box-shadow:0 2px 8px rgba(0,0,0,.55);
    }
    .mobile-bar-text-block {
      display:flex; flex-direction:column; align-items:center; gap:2px; width:100%;
    }
    .mobile-bar-name {
      font-size:9px; font-weight:800; color:#fff;
      text-shadow:0 1px 3px rgba(0,0,0,0.9);
      line-height:1.25; word-break:break-word; text-align:center;
    }
    .mobile-bar-dur {
      font-size:8px; font-weight:700; color:rgba(255,255,255,0.82);
      text-shadow:0 1px 2px rgba(0,0,0,0.8); white-space:nowrap;
    }

    /* Finish time: large, bold, dark backdrop — easy to read (FIX #4) */
    .mobile-bar-end {
      position:absolute; bottom:4px; left:3px; right:3px; text-align:center;
      font-size:9.5px; font-weight:800; color:#fff;
      text-shadow:0 1px 3px rgba(0,0,0,0.95);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      pointer-events:none;
      background:rgba(0,0,0,0.4); border-radius:4px; padding:2px 3px;
    }

    .mobile-boost-dot {
      position:absolute; width:14px; height:14px; background:#fff; border-radius:50%;
      right:3px; display:flex; align-items:center; justify-content:center;
      font-size:8px; box-shadow:0 1px 4px rgba(0,0,0,.5); pointer-events:none;
    }

    /* Bottom sheet */
    .mobile-sheet {
      position:fixed; bottom:0; left:0; right:0; z-index:9999;
      background:linear-gradient(160deg,#2a2a2f,#1e1e24);
      border:1.5px solid rgba(245,208,76,.3); border-bottom:none;
      border-radius:20px 20px 0 0; padding:20px 20px 36px;
      box-shadow:0 -8px 40px rgba(0,0,0,.7); animation:slideUp .2s ease;
    }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    .sheet-handle { width:36px; height:4px; background:rgba(255,255,255,.2); border-radius:2px; margin:0 auto 16px; }
    .sheet-title  { font-size:15px; font-weight:800; color:#fff; margin-bottom:12px; }
    .sheet-row    { display:flex; justify-content:space-between; margin-bottom:8px; }
    .sheet-label  { font-size:10px; color:var(--text-dim); font-weight:700; text-transform:uppercase; }
    .sheet-value  { font-size:12px; color:#fff; font-weight:600; }
    .sheet-boost  { margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,.08); font-size:11px; color:var(--gold); font-weight:700; }
  </style>
</head>
<body>

<header class="gantt-header">
  <button class="back-btn" onclick="window.location.href='index.html'">← Back</button>
  <div class="gantt-title">⚒️ Build Schedule</div>
  <button class="refresh-btn" id="refreshBtn" onclick="loadGantt()">↻ Refresh</button>
</header>

<div class="builder-toggles" id="builderToggles">
  <button class="toggle-btn active" data-b="1" onclick="toggleBuilder(1)">
    <img src="Images/Builders/Builder 1.png" onerror="this.style.display='none'" alt="">Builder 1</button>
  <button class="toggle-btn active" data-b="2" onclick="toggleBuilder(2)">
    <img src="Images/Builders/Builder 2.png" onerror="this.style.display='none'" alt="">Builder 2</button>
  <button class="toggle-btn active" data-b="3" onclick="toggleBuilder(3)">
    <img src="Images/Builders/Builder 3.png" onerror="this.style.display='none'" alt="">Builder 3</button>
  <button class="toggle-btn active" data-b="4" onclick="toggleBuilder(4)">
    <img src="Images/Builders/Builder 4.png" onerror="this.style.display='none'" alt="">Builder 4</button>
  <button class="toggle-btn active" data-b="5" onclick="toggleBuilder(5)">
    <img src="Images/Builders/Builder 5.png" onerror="this.style.display='none'" alt="">Builder 5</button>
  <button class="toggle-btn active" data-b="6" onclick="toggleBuilder(6)">
    <img src="Images/Builders/Builder 6.png" onerror="this.style.display='none'" alt="">Builder 6</button>
</div>

<!-- DESKTOP -->
<div class="gantt-wrap" id="ganttWrap">
  <div class="state-msg" id="stateMsg"><div class="spinner"></div><span>Loading schedule…</span></div>
  <div id="ganttDesktop" style="display:none"></div>
</div>

<!-- ZOOM CONTROLS (desktop only, shown after load) -->
<div class="zoom-bar" id="zoomBar" style="display:none">
  <span class="zoom-label">Zoom</span>
  <button class="zoom-btn" id="zoomOut">−</button>
  <span class="zoom-level" id="zoomLevel">100%</span>
  <button class="zoom-btn" id="zoomIn">+</button>
</div>

<!-- MOBILE -->
<div class="gantt-mobile" id="ganttMobile">
  <div class="state-msg" id="stateMsgMobile"><div class="spinner"></div><span>Loading schedule…</span></div>
  <div class="mobile-columns-wrapper" id="mobileColumns" style="display:none"></div>
</div>

<div class="gantt-tooltip" id="ganttTooltip"></div>

<script>
/* ── CONFIG ── */
const API_BASE = "https://script.google.com/macros/s/AKfycbzaxmuwpTD9cUzrz4e4k75caCpQrTjEDefs-B5nuEaqlFoMrBHjrhDun3Iy7kPkc9j2/exec";

/* Bright, harmonious palette */
const BUILDER_COLORS = {
  1: '#FF6B6B',   /* coral red   */
  2: '#45B7D1',   /* sky blue    */
  3: '#51CF66',   /* mint green  */
  4: '#FFD43B',   /* amber       */
  5: '#CC5DE8',   /* lavender    */
  6: '#20C997'    /* teal        */
};

const HERO_NAMES = ["Archer Queen","Barbarian King","Grand Warden","Minion Prince","Royal Champion"];
const IMAGE_MAP = {
  "Air Bomb":["Lvl 11"],"Archer Tower":["Lvl 21"],"Blacksmith":["Lvl 9"],
  "Bomb":["Lvl 11&12","Lvl 13&14"],"Builder Hut":["Level 7&8&9"],
  "Dark Elixir Drill":["Lvl 10","Lvl 11"],"Dark Elixir Storage":["Lvl 12"],
  "Elixir Collector":["Lvl 17"],"Elixir Storage":["Lvl 18"],
  "Giant Bomb":["Lvl 6","Lvl 7&8","Lvl 9&10"],"Gold Mine":["Lvl 17"],
  "Gold Storage":["Lvl 18"],"Hidden Tesla":["Lvl 16"],"Monolith":["Lvl 2&3&4"],
  "Mortar":["Lvl 17"],"Scattershot":["Lvl 6&7&8"],"Seeking Air Mine":["Lvl 5&6"],
  "Spring Trap":["Lvl 7&8","Lvl 9&10"],"Town Hall":["Lvl 18"],
  "Wizard Tower":["Lvl 17"],"Workshop":["Lvl 8"],"X-Bow":["Lvl 12&13&14"]
};

function getUpgradeImage(name) {
  if (!name) return 'Images/Upgrades/PH.png';
  const base = 'Images/Upgrades/';
  for (const h of HERO_NAMES) if (name.includes(h)) return base + h + '.png';
  const m = name.match(/^(.+?)\s*(?:#\d+)?\s+(?:Level|Lvl)\s+(\d+)/i);
  if (!m) return base + 'PH.png';
  const bn = m[1].trim(), lv = parseInt(m[2]);
  if (!IMAGE_MAP[bn]) return base + 'PH.png';
  for (const ls of IMAGE_MAP[bn]) {
    if (ls === `Lvl ${lv}` || ls === `Level ${lv}`) return base + bn + ' ' + ls + '.png';
    if (ls.includes('&') && ls.match(/\d+/g).map(Number).includes(lv)) return base + bn + ' ' + ls + '.png';
  }
  return base + 'PH.png';
}

/* ── STATE ── */
let ganttData      = [];
let boostPlan      = [];
let currentWork    = {};
let activeBuilders = new Set([1,2,3,4,5,6]);
let todayStart     = null;
let rangeEnd       = null;
let ganttZoom      = 1.0;   /* 0.25 … 4.0 */

/* ── INIT ── */
document.addEventListener('DOMContentLoaded', () => {
  let u = localStorage.getItem('coc_username');
  if (u && u.endsWith('_CURRENT_WORK')) u = u.replace('_CURRENT_WORK','');
  if (!u || u === 'null' || u.trim() === '') { window.location.href = 'index.html'; return; }
  window.COC_USERNAME = u;

  document.getElementById('zoomIn').addEventListener('click',  () => { ganttZoom = Math.min(ganttZoom + 0.25, 4);    applyZoom(); });
  document.getElementById('zoomOut').addEventListener('click', () => { ganttZoom = Math.max(ganttZoom - 0.25, 0.25); applyZoom(); });

  loadGantt();
});

function applyZoom() {
  document.getElementById('zoomLevel').textContent = Math.round(ganttZoom * 100) + '%';
  renderDesktop();
}

/* ── LOAD ── */
async function loadGantt() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('loading'); btn.textContent = '↻ Loading…';
  setLoading(true);
  try {
    const [details, boosts, work] = await Promise.all([
      fetchAllBuilderDetails(),
      fetchBoostPlan(),
      fetchCurrentWork()
    ]);
    ganttData   = details;
    boostPlan   = boosts;
    currentWork = work;
    stitchTimelines();
    computeRange();
    renderDesktop();
    renderMobile();
    setLoading(false);
  } catch(e) {
    console.error('Gantt load failed:', e);
    document.getElementById('stateMsg').innerHTML       = '<span style="color:#f44336">⚠️ Failed to load.</span>';
    document.getElementById('stateMsgMobile').innerHTML = '<span style="color:#f44336">⚠️ Failed to load.</span>';
  } finally {
    btn.classList.remove('loading'); btn.textContent = '↻ Refresh';
  }
}

function setLoading(on) {
  document.getElementById('stateMsg').style.display       = on ? 'flex'  : 'none';
  document.getElementById('ganttDesktop').style.display   = on ? 'none'  : 'block';
  document.getElementById('stateMsgMobile').style.display = on ? 'flex'  : 'none';
  document.getElementById('mobileColumns').style.display  = on ? 'none'  : 'flex';
  const isMobile = window.innerWidth <= 768;
  document.getElementById('zoomBar').style.display = (!on && !isMobile) ? 'flex' : 'none';
}

async function fetchAllBuilderDetails() {
  const results = [];
  await Promise.all([1,2,3,4,5,6].map(async n => {
    try {
      const res  = await fetch(`${API_BASE}?action=builder_details&username=${window.COC_USERNAME}&builder=Builder_${n}`);
      const data = await res.json();
      if (data.builder && data.upgrades) results.push({ builderNum:n, upgrades:data.upgrades });
    } catch(e) { console.warn(`Builder ${n}:`, e); }
  }));
  results.sort((a,b) => a.builderNum - b.builderNum);
  return results;
}

async function fetchBoostPlan() {
  try {
    const res  = await fetch(`${API_BASE}?action=boost_plan&username=${window.COC_USERNAME}`);
    const data = await res.json();
    if (!data?.table || data.table.length <= 1) return [];
    return data.table.slice(1).map(row => ({ date:row[0], builderRaw:row[2], newFinish:row[4], mode:row[5] }));
  } catch(e) { return []; }
}

async function fetchCurrentWork() {
  try {
    const res  = await fetch(`${API_BASE}?action=current_work_table&username=${window.COC_USERNAME}`);
    const data = await res.json();
    const map  = {};
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const num = row[0]?.toString().match(/(\d+)/)?.[1];
      if (!num) continue;
      map[parseInt(num)] = { upgrade:row[1], finishTime:parseDate(row[2]), timeLeftMs:parseTimeLeftMs(row[3]||'') };
    }
    return map;
  } catch(e) { return {}; }
}

/* ════════════════════════════════════════════
   STITCH — correct start times (FIX #1)
   Active upgrade in queue: start = finishTime − durationMinutes  (real actual start)
   Synthetic (not in queue): start = finishTime − timeLeftMs       (≈ now, shows remaining bar)
   Queued items: chained sequentially after active ends
════════════════════════════════════════════ */
function normalizeUpgradeName(n) { return (n||'').trim().toLowerCase().replace(/\s+/g,' '); }

function stitchTimelines() {
  for (const b of ganttData) {
    const cw = currentWork[b.builderNum];

    if (!cw || !cw.finishTime) {
      for (const upg of b.upgrades) {
        upg._startDate = parseDate(upg.start);
        upg._endDate   = parseDate(upg.end);
        upg._isCurrent = false;
      }
      continue;
    }

    const cwEnd = new Date(cw.finishTime);
    let queueStartIdx = 0;

    if (b.upgrades.length > 0 &&
        normalizeUpgradeName(b.upgrades[0].upgrade) === normalizeUpgradeName(cw.upgrade)) {
      /* Active upgrade IS first item in queue.
         Real start = finishTime − total duration (durationMinutes from API). */
      const mins0 = b.upgrades[0].durationMinutes || 0;
      b.upgrades[0]._startDate = mins0 > 0
        ? new Date(cwEnd.getTime() - mins0 * 60000)          /* ← correct actual start */
        : new Date(cwEnd.getTime() - (cw.timeLeftMs || 0));  /* fallback if no duration */
      b.upgrades[0]._endDate   = cwEnd;
      b.upgrades[0]._isCurrent = true;
      queueStartIdx = 1;
    } else {
      /* Active upgrade NOT in queue — synthetic bar.
         Show from (finishTime − timeLeft) → finishTime so bar = remaining time. */
      const synStart = cw.timeLeftMs > 0
        ? new Date(cwEnd.getTime() - cw.timeLeftMs)
        : new Date();
      b.upgrades.unshift({
        upgrade:cw.upgrade, duration:'', durationMinutes:Math.round((cw.timeLeftMs||0)/60000),
        _startDate:synStart, _endDate:cwEnd, _isCurrent:true, _synthetic:true
      });
      queueStartIdx = 1;
    }

    /* Chain queue sequentially */
    let cursor = cwEnd;
    for (let i = queueStartIdx; i < b.upgrades.length; i++) {
      const upg = b.upgrades[i];
      const mins = upg.durationMinutes || 0;
      upg._startDate = new Date(cursor);
      upg._endDate   = new Date(cursor.getTime() + mins * 60000);
      upg._isCurrent = false;
      cursor = upg._endDate;
    }
  }
}

/* ── DATE HELPERS ── */
function parseDate(raw) {
  if (!raw) return null;
  if (raw instanceof Date) return raw;
  if (typeof raw === 'string' && (raw.includes('T') || raw.match(/^\d{4}-/))) {
    const d = new Date(raw); if (!isNaN(d)) return d;
  }
  const yr = new Date().getFullYear();
  for (const y of [yr, yr+1]) { const d = new Date(`${raw} ${y}`); if (!isNaN(d)) return d; }
  return null;
}
function daysBetween(a, b) { return (b - a) / 86400000; }
function parseTimeLeftMs(s) {
  const dm = (s.match(/(\d+)\s*d/)  ||[0,0])[1];
  const hm = (s.match(/(\d+)\s*hr/) ||[0,0])[1];
  const mm = (s.match(/(\d+)\s*min/)||[0,0])[1];
  return (parseInt(dm)*1440 + parseInt(hm)*60 + parseInt(mm)) * 60000;
}
function fmtDate(d) {
  if (!d||isNaN(d)) return '—';
  return d.toLocaleString('en-US',{timeZone:'America/New_York',month:'short',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
}
function fmtDay(d) { return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}); }
function fmtShort(d) {
  if (!d||isNaN(d)) return '';
  return d.toLocaleString('en-US',{timeZone:'America/New_York',month:'numeric',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
}

/* ── RANGE ── */
function computeRange() {
  todayStart = new Date(); todayStart.setHours(0,0,0,0);
  let maxEnd = new Date(todayStart); maxEnd.setDate(maxEnd.getDate() + 7);
  for (const b of ganttData) for (const u of b.upgrades) { if (u._endDate && u._endDate > maxEnd) maxEnd = u._endDate; }
  rangeEnd = new Date(maxEnd); rangeEnd.setHours(23,59,59,999);
}

/* ── BOOSTS ── */
function parseBoostDate(raw) {
  if (!raw||raw==='TODAY') { const d=new Date(); d.setHours(12,0,0,0); return d; }
  const yr = new Date().getFullYear();
  for (const y of [yr,yr+1]) { const d=new Date(`${raw} ${y}`); if (!isNaN(d)) return d; }
  return null;
}
function getBoosts(builderNum, startD, endD) {
  const out = [];
  if (!startD||!endD) return out;
  for (const bp of boostPlan) {
    const n = bp.builderRaw?.match(/(\d+)/)?.[1];
    if (!n||parseInt(n)!==builderNum) continue;
    const bd = parseBoostDate(bp.date);
    if (bd && bd>=startD && bd<=endD) out.push({date:bd,newFinish:bp.newFinish,mode:bp.mode});
  }
  return out;
}
function hexAlpha(hex, a) {
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

/* ════════════════════════════════════════════
   DESKTOP RENDER
   FIX #2: only active rows rendered (no gaps when toggled off)
   FIX #3: zoom + hour sub-ticks
   FIX #4: duration + finish time in bar label
   FIX #5: bar-inner position:sticky (follows horizontal scroll)
   FIX #6: image = full bar height
════════════════════════════════════════════ */
function renderDesktop() {
  const container = document.getElementById('ganttDesktop');
  container.innerHTML = '';

  const PX  = Math.max(Math.round(140 * ganttZoom), 20);  /* px per day */
  const LW  = 130;              /* label-col width */
  const RH  = 90;               /* row height */
  const BT  = 8;                /* bar top offset */
  const BH  = RH - BT * 2;     /* bar height */
  /* Hour sub-tick interval: denser when zoomed in */
  const hourStep = ganttZoom >= 2 ? 2 : ganttZoom >= 1 ? 6 : 12;

  const totalDays = Math.ceil(daysBetween(todayStart, rangeEnd)) + 2;
  const days = Array.from({length:totalDays},(_,i)=>{ const d=new Date(todayStart); d.setDate(d.getDate()+i); return d; });
  const totalW = LW + totalDays * PX;

  const canvas = document.createElement('div');
  canvas.style.cssText = `position:relative; min-width:${totalW}px;`;

  /* ── DATE HEADER ── */
  const header = document.createElement('div');
  header.style.cssText = `display:flex; position:sticky; top:0; z-index:12; background:var(--bg); border-bottom:2px solid var(--border);`;

  const corner = document.createElement('div');
  corner.style.cssText = `width:${LW}px; flex-shrink:0; position:sticky; left:0; z-index:13; background:var(--bg); padding:0 14px; border-right:1px solid var(--border); display:flex; align-items:center; font-size:10px; font-weight:700; color:var(--text-dim); text-transform:uppercase;`;
  corner.textContent = 'Builder';
  header.appendChild(corner);

  days.forEach((d, i) => {
    const isMonth = i > 0 && d.getDate() === 1;
    const cell = document.createElement('div');
    cell.style.cssText = `width:${PX}px; flex-shrink:0; display:flex; flex-direction:column; border-left:${isMonth?'2px solid rgba(255,255,255,0.2)':'1px solid var(--border)'};`;

    const dayLbl = document.createElement('div');
    dayLbl.style.cssText = `padding:5px 0 2px; font-size:${i===0?11:9}px; font-weight:${i===0||isMonth?800:600}; color:${i===0?'var(--gold)':isMonth?'rgba(255,255,255,0.55)':'var(--text-dim)'}; text-align:center; white-space:nowrap;`;
    dayLbl.textContent = i===0 ? 'TODAY' : fmtDay(d);
    cell.appendChild(dayLbl);

    /* Hour sub-label row (FIX #3) */
    const hourRow = document.createElement('div');
    hourRow.style.cssText = `flex:1; display:flex; border-top:1px solid var(--border);`;
    for (let h = 0; h < 24; h += hourStep) {
      const hd = document.createElement('div');
      hd.style.cssText = `flex:${hourStep}; font-size:7px; color:rgba(255,255,255,0.2); font-weight:600; padding:2px 1px; border-left:${h===0?'none':'1px solid rgba(255,255,255,0.04)'}; white-space:nowrap; overflow:hidden;`;
      hd.textContent = h === 0 ? '' : `${h}h`;
      hourRow.appendChild(hd);
    }
    cell.appendChild(hourRow);
    header.appendChild(cell);
  });
  canvas.appendChild(header);

  /* ── ROWS — only visible builders, no gap (FIX #2) ── */
  const visible = ganttData.filter(b => activeBuilders.has(b.builderNum));

  visible.forEach((b, bi) => {
    const bColor = BUILDER_COLORS[b.builderNum];

    const row = document.createElement('div');
    row.style.cssText = `display:flex; position:relative; height:${RH}px; border-bottom:1px solid var(--border);`;
    row.dataset.builder = b.builderNum;

    /* Sticky label column */
    const labelEl = document.createElement('div');
    labelEl.style.cssText = `width:${LW}px; flex-shrink:0; position:sticky; left:0; z-index:9; background:var(--bg); display:flex; align-items:center; gap:8px; padding:0 12px; border-right:1px solid var(--border); border-left:3px solid ${bColor};`;
    labelEl.innerHTML = `
      <img src="Images/Builders/Builder ${b.builderNum}.png" style="width:30px;height:30px;object-fit:contain" onerror="this.style.display='none'" alt="">
      <div>
        <div style="font-size:12px;font-weight:800;color:${bColor};line-height:1.2">Builder ${b.builderNum}</div>
        <div style="font-size:9px;color:var(--text-dim);font-weight:600">${b.upgrades.length} upgrade${b.upgrades.length!==1?'s':''}</div>
      </div>`;
    row.appendChild(labelEl);

    const cell = document.createElement('div');
    cell.style.cssText = `position:relative; flex:1; height:${RH}px; overflow:visible;`;

    /* Grid lines + hour sub-ticks */
    days.forEach((d, i) => {
      const isMonth = i > 0 && d.getDate() === 1;
      const dl = document.createElement('div');
      dl.style.cssText = `position:absolute; top:0; bottom:0; left:${i*PX}px; width:${isMonth?2:1}px; background:${i===0?'rgba(245,208,76,0.18)':isMonth?'rgba(255,255,255,0.13)':'var(--border)'};`;
      cell.appendChild(dl);
      for (let h = hourStep; h < 24; h += hourStep) {
        const ht = document.createElement('div');
        ht.style.cssText = `position:absolute; top:0; bottom:0; left:${i*PX+(h/24)*PX}px; width:1px; background:rgba(255,255,255,0.03);`;
        cell.appendChild(ht);
      }
      if (isMonth && bi === 0) {
        const ml = document.createElement('div');
        ml.style.cssText = `position:absolute; top:2px; left:${i*PX+4}px; font-size:8px; font-weight:800; color:rgba(255,255,255,0.26); letter-spacing:1px; text-transform:uppercase; pointer-events:none; z-index:2;`;
        ml.textContent = d.toLocaleDateString('en-US',{month:'short'}).toUpperCase();
        cell.appendChild(ml);
      }
    });

    if (bi===0) {
      const nowPin = document.createElement('div');
      nowPin.style.cssText = `position:absolute; top:0; left:0; transform:translateX(-50%); background:var(--gold); color:#000; font-size:8px; font-weight:800; padding:2px 6px; border-radius:0 0 4px 4px; white-space:nowrap; z-index:20;`;
      nowPin.textContent = 'NOW';
      cell.appendChild(nowPin);
    }

    /* ── BARS ── */
    b.upgrades.forEach((upg, idx) => {
      const startD = upg._startDate, endD = upg._endDate;
      if (!startD||!endD) return;
      const clampS = Math.max(startD.getTime(), todayStart.getTime());
      const clampE = Math.min(endD.getTime(),   rangeEnd.getTime());
      if (clampS >= clampE) return;

      const leftPx  = daysBetween(todayStart, new Date(clampS)) * PX;
      const widthPx = Math.max(daysBetween(new Date(clampS), new Date(clampE)) * PX, 6);

      const isEven  = idx % 2 === 0;
      const barCol  = isEven ? bColor : hexAlpha(bColor, 0.58);
      const bordCol = upg._isCurrent ? '#ffffff' : isEven ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.18)';

      const bar = document.createElement('div');
      bar.className = 'gantt-bar';
      bar.style.cssText = `left:${leftPx}px; width:${widthPx}px; top:${BT}px; height:${BH}px; background:${barCol}; border-color:${bordCol};`;

      if (upg._isCurrent) {
        const badge = document.createElement('div');
        badge.className = 'bar-active-badge';
        badge.textContent = '▶ ACTIVE';
        bar.appendChild(badge);
      }

      /* ── STICKY LABEL — follows horizontal scroll (FIX #5) ── */
      const inner = document.createElement('div');
      inner.className = 'bar-inner';
      inner.style.left = LW + 'px'; /* pin label to right edge of label column */

      /* Image = full bar height (FIX #6) */
      const imgEl = document.createElement('img');
      imgEl.className = 'bar-icon';
      imgEl.style.cssText = `width:${BH}px; height:${BH}px;`;
      imgEl.src = getUpgradeImage(upg.upgrade);
      imgEl.onerror = () => imgEl.src = 'Images/Upgrades/PH.png';
      imgEl.alt = upg.upgrade || '';
      inner.appendChild(imgEl);

      /* Name + duration + finish time (FIX #4) */
      const textCol = document.createElement('div');
      textCol.className = 'bar-text-col';
      textCol.innerHTML = `
        <div class="bar-name">${upg.upgrade||''}</div>
        ${upg.duration ? `<div class="bar-dur">${upg.duration}</div>` : ''}
        <div class="bar-finish-lbl">→ ${fmtShort(endD)}</div>`;
      inner.appendChild(textCol);
      bar.appendChild(inner);

      /* Boost markers */
      const boosts = getBoosts(b.builderNum, startD, endD);
      boosts.forEach(boost => {
        const bPx = daysBetween(todayStart, boost.date) * PX - leftPx;
        if (bPx < 0 || bPx > widthPx) return;
        const dot = document.createElement('div');
        dot.className = 'gantt-boost-marker';
        dot.style.left = Math.max(bPx-7, 0) + 'px';
        dot.textContent = '⚡';
        bar.appendChild(dot);
      });

      bar.addEventListener('mouseenter', e => showTooltip(e, upg, b.builderNum, boosts, startD, endD));
      bar.addEventListener('mousemove',  e => moveTooltip(e));
      bar.addEventListener('mouseleave', hideTooltip);
      cell.appendChild(bar);
    });

    row.appendChild(cell);
    canvas.appendChild(row);
  });

  container.appendChild(canvas);
}

/* ════════════════════════════════════════════
   MOBILE RENDER
   FIX #2: hidden-col hides column entirely (flex gap closes)
   FIX #4: larger finish time label
   FIX #6: 44px image, text below image
════════════════════════════════════════════ */
function renderMobile() {
  const wrapper = document.getElementById('mobileColumns');
  wrapper.innerHTML = '';

  const PX = 110;       /* px per day */
  const COL_HEAD_H = 84;
  /* sticky top for label = top of page headers + col header */
  const STICKY_TOP = 51 + 50 + COL_HEAD_H - 8;

  const totalDays = Math.ceil(daysBetween(todayStart, rangeEnd)) + 2;
  const days = Array.from({length:totalDays},(_,i)=>{ const d=new Date(todayStart); d.setDate(d.getDate()+i); return d; });
  const bodyH = totalDays * PX;

  /* Time axis */
  const axis = document.createElement('div');
  axis.className = 'mobile-time-axis';
  const axisHead = document.createElement('div');
  axisHead.className = 'mobile-time-header';
  axisHead.textContent = 'Date';
  axis.appendChild(axisHead);
  days.forEach((d,i) => {
    const t = document.createElement('div');
    t.className = 'mobile-time-tick' + (i===0?' today-row':'');
    t.style.height = PX + 'px';
    t.textContent = i===0 ? '▶ Now' : fmtDay(d);
    axis.appendChild(t);
  });
  wrapper.appendChild(axis);

  /* Builder columns */
  for (let n = 1; n <= 6; n++) {
    const bd = ganttData.find(b => b.builderNum === n);
    const bColor = BUILDER_COLORS[n];

    const col = document.createElement('div');
    col.className = 'mobile-builder-col';
    col.dataset.builder = n;
    if (!activeBuilders.has(n)) col.classList.add('hidden-col');

    const colHead = document.createElement('div');
    colHead.className = 'mobile-col-header';
    colHead.style.borderBottomColor = bColor;
    colHead.innerHTML = `
      <img src="Images/Builders/Builder ${n}.png" onerror="this.style.display='none'" alt="">
      <span style="color:${bColor}">B${n}</span>`;
    col.appendChild(colHead);

    const colBody = document.createElement('div');
    colBody.className = 'mobile-col-body';
    colBody.style.height = bodyH + 'px';

    days.forEach((d,i) => {
      const isMonth = i > 0 && d.getDate() === 1;
      const dr = document.createElement('div');
      dr.style.cssText = `position:absolute; left:0; right:0; top:${i*PX}px; height:${PX}px; border-top:${isMonth?'2px':'1px'} solid ${i===0?'rgba(245,208,76,0.3)':isMonth?'rgba(255,255,255,0.16)':'var(--border)'};`;
      colBody.appendChild(dr);
    });

    if (bd) {
      bd.upgrades.forEach((upg, idx) => {
        const startD = upg._startDate, endD = upg._endDate;
        if (!startD||!endD) return;
        const clampS = Math.max(startD.getTime(), todayStart.getTime());
        const clampE = Math.min(endD.getTime(),   rangeEnd.getTime());
        if (clampS >= clampE) return;

        const topPx = daysBetween(todayStart, new Date(clampS)) * PX;
        const hPx   = Math.max(daysBetween(new Date(clampS), new Date(clampE)) * PX, 8);

        const isEven = idx % 2 === 0;
        const barCol  = isEven ? bColor : hexAlpha(bColor, 0.6);
        const bordCol = upg._isCurrent ? '#fff' : isEven ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.2)';

        const bar = document.createElement('div');
        bar.className = 'mobile-bar';
        bar.style.cssText = `top:${topPx}px; height:${hPx}px; background:${barCol}; border-color:${bordCol};`;

        /* Sticky label (FIX #5) */
        const lbl = document.createElement('div');
        lbl.className = 'mobile-bar-label';
        lbl.style.top = STICKY_TOP + 'px';

        /* Large image — text below (FIX #6) */
        const imgEl = document.createElement('img');
        imgEl.className = 'mobile-bar-icon';
        imgEl.src = getUpgradeImage(upg.upgrade);
        imgEl.onerror = () => imgEl.src = 'Images/Upgrades/PH.png';
        imgEl.alt = upg.upgrade || '';
        lbl.appendChild(imgEl);

        const tb = document.createElement('div');
        tb.className = 'mobile-bar-text-block';
        tb.innerHTML = `
          <div class="mobile-bar-name">${upg.upgrade||''}</div>
          ${upg.duration ? `<div class="mobile-bar-dur">${upg.duration}</div>` : ''}`;
        lbl.appendChild(tb);
        bar.appendChild(lbl);

        /* Large finish time (FIX #4) */
        const endLbl = document.createElement('div');
        endLbl.className = 'mobile-bar-end';
        endLbl.textContent = fmtShort(endD);
        bar.appendChild(endLbl);

        /* Boost dots */
        getBoosts(n, startD, endD).forEach(boost => {
          const bTop = daysBetween(new Date(clampS), boost.date) * PX;
          if (bTop < 0 || bTop > hPx) return;
          const dot = document.createElement('div');
          dot.className = 'mobile-boost-dot';
          dot.style.top = (bTop+2) + 'px';
          dot.textContent = '⚡';
          bar.appendChild(dot);
        });

        const boosts = getBoosts(n, startD, endD);
        bar.addEventListener('click', e => { e.stopPropagation(); showSheet(upg, n, boosts, startD, endD); });
        colBody.appendChild(bar);
      });
    }

    col.appendChild(colBody);
    wrapper.appendChild(col);
  }
}

/* ── TOOLTIP (desktop) ── */
const tooltip = document.getElementById('ganttTooltip');
function showTooltip(e, upg, bNum, boosts, startD, endD) {
  let html = `<div class="tt-name">${upg._isCurrent?'▶ ACTIVE &nbsp;':''}${upg.upgrade||''}</div>`;
  html += `<div class="tt-row"><span class="tt-label">Start</span><span class="tt-value">${fmtDate(startD)}</span></div>`;
  html += `<div class="tt-row"><span class="tt-label">End</span><span class="tt-value">${fmtDate(endD)}</span></div>`;
  html += `<div class="tt-row"><span class="tt-label">Duration</span><span class="tt-value">${upg.duration||'—'}</span></div>`;
  if (boosts.length) {
    html += `<div class="tt-boost">⚡ ${boosts.length} boost${boosts.length>1?'s':''}</div>`;
    boosts.forEach(b => { html += `<div class="tt-boost-row">• ${fmtDate(b.date)} → ${b.newFinish}</div>`; });
  }
  tooltip.innerHTML = html;
  tooltip.classList.add('visible');
  moveTooltip(e);
}
function moveTooltip(e) {
  const vw=window.innerWidth, vh=window.innerHeight, tw=295, th=190;
  let x=e.clientX+16, y=e.clientY+16;
  if (x+tw>vw) x=e.clientX-tw-8;
  if (y+th>vh) y=e.clientY-th-8;
  tooltip.style.left=x+'px'; tooltip.style.top=y+'px';
}
function hideTooltip() { tooltip.classList.remove('visible'); }
document.addEventListener('click', e => { if (!e.target.closest('.gantt-bar')) hideTooltip(); });

/* ── BOTTOM SHEET (mobile) ── */
function showSheet(upg, bNum, boosts, startD, endD) {
  document.querySelector('.mobile-sheet')?.remove();
  const s = document.createElement('div');
  s.className = 'mobile-sheet';
  let bHtml = '';
  if (boosts.length) {
    bHtml = `<div class="sheet-boost">⚡ ${boosts.length} boost${boosts.length>1?'s':''}</div>`;
    boosts.forEach(b => { bHtml += `<div style="font-size:10px;color:#ccc;margin-top:4px">• ${fmtDate(b.date)} → ${b.newFinish}</div>`; });
  }
  s.innerHTML = `
    <div class="sheet-handle"></div>
    <div class="sheet-title">${upg._isCurrent?'▶ ':''}${upg.upgrade||''}</div>
    <div class="sheet-row"><span class="sheet-label">Start</span><span class="sheet-value">${fmtDate(startD)}</span></div>
    <div class="sheet-row"><span class="sheet-label">End</span><span class="sheet-value">${fmtDate(endD)}</span></div>
    <div class="sheet-row"><span class="sheet-label">Duration</span><span class="sheet-value">${upg.duration||'—'}</span></div>
    ${bHtml}`;
  document.body.appendChild(s);
  setTimeout(()=>document.addEventListener('click',()=>document.querySelector('.mobile-sheet')?.remove(),{once:true}),100);
}

/* ── TOGGLE BUILDERS (FIX #2: re-render desktop so no gap; hide mobile col) ── */
function toggleBuilder(n) {
  const btn = document.querySelector(`.toggle-btn[data-b="${n}"]`);
  if (activeBuilders.has(n)) { activeBuilders.delete(n); btn.classList.remove('active'); }
  else                        { activeBuilders.add(n);   btn.classList.add('active'); }
  renderDesktop();   /* desktop: full re-render, only active rows appear */
  const mc = document.querySelector(`.mobile-builder-col[data-builder="${n}"]`);
  if (mc) mc.classList.toggle('hidden-col', !activeBuilders.has(n));
}
</script>
</body>
</html>
